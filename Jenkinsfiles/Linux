#!/usr/bin/env groovy

def SLAVE_NODE = ''

pipeline {
  agent {
    label 'betrfs'
  }

  stages {
    stage('Build') {
      steps {

        script {
          SLAVE_NODE = sh(script: 'hostname -s', returnStdout: true).trim()
        }

        sh '''
	# Need link to source or build fails
	wget https://auku.cs.unc.edu/depot/linux-source-3.11.10-ftfs_20180618.00_all.deb
	sudo dpkg -i linux-source-3.11.10-ftfs_20180618.00_all.deb
	sudo tar -xvf /usr/src/linux-source-3.11.10-ftfs.tar.bz2
	sudo mv linux-source-3.11.10-ftfs linux-3.11.10
        mkdir -p build
        cp cmake-ft.sh build/
        cd build
        ./cmake-ft.sh
        cd ../ftfs
        make
        '''
      }
    }

    stage('Unit Testing') {
      steps {
        timeout(time: 3, unit: 'HOURS'){
          sh '''
          cd ftfs/userspace-testing/
	  sudo ln -s ../ftfs.ko ftfs.ko
          sudo ./run-tests.py all.tests
          '''
        }
      }
    }
  }

  post {
    always {
      node("master") {
        sh """
        cd ~jenkins/scripts
        sudo ./dump-console.sh ${SLAVE_NODE}
        sudo ./clean-vm.sh ${SLAVE_NODE}
        """
      }
    }
  }
} 
